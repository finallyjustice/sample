Guest and KVM haltpoll: rt-tests

This is about how to test guest haltpoll and KVM haltpoll by running rt-tests at the guest side.

https://mirrors.edge.kernel.org/pub/linux/utils/rt-tests/rt-tests-1.10.tar.xz

https://lore.kernel.org/all/CAJuRqcC0Z-wbAhb39ofKPstgbg+ZmsT8eFivWEr-hZY64_A1xA@mail.gmail.com/

The test environment. By default the guest haltpoll is enabled (unlike uek6/mainline).

VM  : 4.14.35-2047.512.6.el7uek.x86_64
KVM : 4.14.35-2047.505.4.4.el7uek.x86_64
QEMU: 7.0.0


The below is the command line to create the guest.

qemu-system-x86_64 -smp 4 -m 32G -enable-kvm -cpu host -vnc :7 \
-device virtio-scsi-pci,id=vscsi0,num_queues=8 \
-device scsi-hd,drive=drive0,bus=vscsi0.0,channel=0,scsi-id=0,lun=0 \
-drive file=ol7.qcow2,if=none,id=drive0 \
-net nic -net user,hostfwd=tcp::5027-:22 \
-serial stdio

----------------------------------------------

The guest haltpoll.

1. Boot an OL7 VM.

2. Run cyclictest with 200us latency.

vm# ./cyclictest -i 200

3. Here is the CPU usage at guest and host side.

The %guest at host side is almost 100%, while it is almost idle at guest side. (I just don't know why there are 4 CPUs with high %guest usage).

This is from host side.

08:16:57 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:16:58 AM  all    0.04    0.00    0.12    0.00    0.04    0.04    0.00   16.46    0.00   83.29
08:16:58 AM    0    0.00    0.00    0.00    0.00    0.00    0.99    0.00    0.00    0.00   99.01
08:16:58 AM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM    3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM    4    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM    5    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM    6    0.00    0.00    0.99    0.00    0.99    0.00    0.00   98.02    0.00    0.00
08:16:58 AM    7    0.00    0.00    1.00    0.00    0.00    0.00    0.00   99.00    0.00    0.00
08:16:58 AM    8    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM    9    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   10    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   11    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   12    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   13    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   14    1.00    0.00    2.00    0.00    0.00    0.00    0.00   97.00    0.00    0.00
08:16:58 AM   15    0.99    0.00    0.99    0.00    0.00    0.00    0.00   98.02    0.00    0.00
08:16:58 AM   16    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   17    1.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00
08:16:58 AM   18    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   19    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   20    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   21    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   22    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:58 AM   23    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00

This is from guest side.

08:16:56 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:16:57 AM  all    0.25    0.00    0.00    0.00    0.25    0.25    0.00    0.00    0.00   99.25
08:16:57 AM    0    0.00    0.00    0.00    0.00    1.02    0.00    0.00    0.00    0.00   98.98
08:16:57 AM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:57 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:57 AM    3    0.99    0.00    0.00    0.00    0.00    0.99    0.00    0.00    0.00   98.02

08:16:57 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:16:58 AM  all    0.50    0.00    0.75    0.00    0.50    0.00    0.00    0.00    0.00   98.25
08:16:58 AM    0    0.00    0.00    1.01    0.00    1.01    0.00    0.00    0.00    0.00   97.98
08:16:58 AM    1    1.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00
08:16:58 AM    2    0.99    0.00    0.99    0.00    0.00    0.00    0.00    0.00    0.00   98.02
08:16:58 AM    3    0.00    0.00    1.01    0.00    1.01    0.00    0.00    0.00    0.00   97.98

08:16:58 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:16:59 AM  all    0.00    0.00    0.25    0.00    0.50    0.25    0.00    0.00    0.00   98.99
08:16:59 AM    0    0.00    0.00    0.00    0.00    1.02    0.00    0.00    0.00    0.00   98.98
08:16:59 AM    1    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00
08:16:59 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:16:59 AM    3    0.00    0.00    0.00    0.00    1.00    1.00    0.00    0.00    0.00   98.00

----------------------------------------------

The KVM haltpoll.

kvm# cat /sys/module/kvm/parameters/halt_poll_ns
200000
kvm# cat /sys/module/kvm/parameters/halt_poll_ns_grow 
2
kvm# cat /sys/module/kvm/parameters/halt_poll_ns_shrink 
0

1. Boot an OL7 VM, with "idle=halt" in guest kernel command line.

2. Run cyclictest with 200us latency.

vm# ./cyclictest -i 200

3. Here is the data.

The host side has one CPU with 100% sys, while the guest side is almost idle.

This is from host side.

08:52:15 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:52:16 AM  all    0.04    0.00    4.21    0.00    0.04    0.00    0.00    0.08    0.00   95.62
08:52:16 AM    0    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    4    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    5    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    6    0.00    0.00  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
08:52:16 AM    7    0.00    0.00    0.00    0.00    0.00    0.00    0.00    1.01    0.00   98.99
08:52:16 AM    8    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    9    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   10    0.00    0.00    0.00    0.00    1.00    0.00    0.00    1.00    0.00   98.00
08:52:16 AM   11    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   12    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   13    1.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00
08:52:16 AM   14    0.00    0.00    0.99    0.00    0.00    0.99    0.00    0.00    0.00   98.02
08:52:16 AM   15    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   16    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   17    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   18    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   19    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   20    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   21    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   22    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM   23    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00

This is from guest side.

08:52:14 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:52:15 AM  all    0.00    0.00    0.25    0.00    0.50    0.50    0.25    0.00    0.00   98.50
08:52:15 AM    0    0.00    0.00    0.00    0.00    1.02    0.00    0.00    0.00    0.00   98.98
08:52:15 AM    1    0.00    0.00    0.00    0.00    0.98    0.98    0.98    0.00    0.00   97.06
08:52:15 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:15 AM    3    0.00    0.00    1.00    0.00    0.00    1.00    0.00    0.00    0.00   98.00

08:52:15 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:52:16 AM  all    0.00    0.00    0.25    0.00    0.25    0.00    0.00    0.00    0.00   99.49
08:52:16 AM    0    0.00    0.00    0.00    0.00    1.03    0.00    0.00    0.00    0.00   98.97
08:52:16 AM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:52:16 AM    3    0.00    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   98.99

4. Run cyclictest with higher latency value.

# vm# ./cyclictest -i 210

5. This time the %sys at host side is reduced. This matches with the mailing list discussion.

This is from host side.

08:53:10 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:53:11 AM  all    0.00    0.00    2.17    0.00    0.04    0.04    0.00    0.33    0.00   97.41
08:53:11 AM    0    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00
08:53:11 AM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM    3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM    4    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM    5    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM    6    0.00    0.00   49.50    0.00    0.99    0.00    0.00    6.93    0.00   42.57
08:53:11 AM    7    1.02    0.00    0.00    0.00    1.02    0.00    0.00    0.00    0.00   97.96
08:53:11 AM    8    1.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   98.00
08:53:11 AM    9    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   10    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   11    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   12    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   13    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   14    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   15    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   16    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   17    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   18    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   19    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   20    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   21    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   22    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM   23    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00


This is from guest side.

08:53:09 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:53:10 AM  all    0.50    0.00    0.75    0.00    0.25    0.00    0.00    0.00    0.00   98.49
08:53:10 AM    0    2.02    0.00    1.01    0.00    1.01    0.00    0.00    0.00    0.00   95.96
08:53:10 AM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:10 AM    2    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00
08:53:10 AM    3    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00

08:53:10 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:53:11 AM  all    0.50    0.00    0.50    0.00    1.00    0.25    0.25    0.00    0.00   97.51
08:53:11 AM    0    2.00    0.00    0.00    0.00    2.00    0.00    1.00    0.00    0.00   95.00
08:53:11 AM    1    0.00    0.00    1.00    0.00    1.00    0.00    0.00    0.00    0.00   98.00
08:53:11 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:11 AM    3    0.00    0.00    0.99    0.00    0.99    0.99    0.00    0.00    0.00   97.03

08:53:11 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:53:12 AM  all    0.76    0.00    0.25    0.00    0.51    0.00    0.00    0.00    0.00   98.48
08:53:12 AM    0    3.06    0.00    0.00    0.00    1.02    0.00    0.00    0.00    0.00   95.92
08:53:12 AM    1    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00    0.00   98.99
08:53:12 AM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:53:12 AM    3    0.00    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   98.99
